<div class="bg-[#080808] text-[#f0f0f0] min-h-screen overflow-x-hidden">

  @if (attempt; as attempt) {

  <!-- â•â• NAV â•â• -->
  <nav class="fixed inset-x-0 top-0 z-40 flex items-center justify-between
              px-8 md:px-16 py-4 bg-[#080808]/90 backdrop-blur border-b border-g">
    <a routerLink="/" class="mono font-bold tracking-widest text-sm text-[#00ff41]">
      angul<span class="text-[#f0f0f0]">-it</span>
    </a>

    <!-- stage pills â€” dynamic -->
    <div class="hidden md:flex items-center gap-2">
      @for (ch of attempt.challengeOrder; track ch; let i = $index) {
        <div class="stage-tab mono text-[10px] tracking-widest uppercase px-3 py-1 border"
             [class.done]="i < attempt.currentStage"
             [class.active]="i === attempt.currentStage"
             [class.locked]="i > attempt.currentStage">
          0{{ i + 1 }} {{ ch }}
        </div>
        @if (i < attempt.totalStages - 1) {
          <div class="w-6 h-px bg-[#1a1a1a]"></div>
        }
      }
    </div>

    <div class="flex items-center gap-2">
      <span class="w-2 h-2 rounded-full bg-[#00ff41] pulse-dot"></span>
      <span class="mono text-[#00ff41] text-xs tracking-widest">
        Stage {{ attempt.currentStage + 1 }} / {{ attempt.totalStages }}
      </span>
    </div>
  </nav>

  <!-- â•â• MAIN â•â• -->
  <main class="relative min-h-screen flex flex-col items-center justify-center
               px-4 md:px-8 pt-28 pb-16 overflow-hidden">

    <div class="scan-sweep"></div>

    <!-- progress bar -->
    <div class="w-full max-w-2xl mb-8 relative z-10">
      <div class="flex items-center justify-between mb-2">
        <span class="mono text-[#333] text-[10px] tracking-widest uppercase">Overall Progress</span>
        <span class="mono text-[#00ff41] text-[10px] tracking-widest">{{ progress }}%</span>
      </div>
      <div class="w-full h-px bg-[#111]">
        <div class="h-px bg-[#00ff41] transition-all duration-500"
             [style.width.%]="progress"
             style="box-shadow:0 0 6px #00ff41">
        </div>
      </div>
    </div>

    <!-- â”€â”€ ACTIVE CHALLENGE CARD â”€â”€ -->
    <div class="w-full max-w-2xl bg-[#0a0a0a] border border-g card-line relative z-10">

      <!-- card header â€” dynamic âœ… -->
      <div class="flex items-center justify-between px-6 md:px-8 py-5 border-b border-g">
        <div>
          <div class="mono text-[#00ff41] text-xs tracking-widest uppercase mb-1">
            // Challenge {{ (attempt.currentStage + 1) | number:'2.0-0' }}  <!-- âœ… dynamic -->
          </div>
          <div class="font-bold text-lg leading-tight">
            {{ challengeTitles[currentChallenge] }}  <!-- âœ… dynamic -->
          </div>
        </div>

        <!-- timer only for math-equation -->
        @if (currentChallenge === 'math-equation') {
          <div class="border border-g px-4 py-2 text-center">
            <div class="mono text-[#00ff41] text-xl font-bold leading-none">
              <!-- timer lives in the child component -->
            </div>
            <div class="mono text-[#333] text-[9px] tracking-widest uppercase mt-1">Remaining</div>
          </div>
        }
      </div>

      <!-- card body â€” switch on challengeType not index âœ… -->
      <div class="px-6 md:px-8 py-8">
        @switch (currentChallenge) {
          @case ('image-select') {
            <app-image-select (completed)="onStageComplete($event)" />
          }
          @case ('math-equation') {
            <app-math-equation (completed)="onStageComplete($event)" />
          }
          @case ('text-input') {
            <app-text-input (completed)="onStageComplete($event)" />
          }
          @case ('puzzle') {
            <app-puzzle (completed)="onStageComplete($event)" />
          }
        }
      </div>

      <!-- card footer -->
      <div class="px-6 md:px-8 py-5 border-t border-g flex items-center justify-between gap-4">

        <!-- âœ… button not anchor -->
        <button (click)="onPrevious()"
                [disabled]="attempt.currentStage === 0"
                class="mono text-[#333] text-xs tracking-widest uppercase
                       hover:text-[#f0f0f0] transition-colors flex items-center gap-2
                       disabled:opacity-20 disabled:cursor-not-allowed">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Previous
        </button>

        <!-- stage dots â€” dynamic âœ… -->
        <div class="flex items-center gap-2">
          @for (ch of attempt.challengeOrder; track ch; let i = $index) {
            <span class="w-2 h-2 rounded-full transition-all duration-300"
                  [style.background]="i <= attempt.currentStage ? '#00ff41' : '#1e1e1e'"
                  [style.box-shadow]="i <= attempt.currentStage ? '0 0 6px #00ff41' : 'none'">
            </span>
          }
        </div>

        <button (click)="onNext()"
                [disabled]="!canProceed"
                class="glow-btn mono bg-[#00ff41] text-[#080808] font-bold
                       text-xs tracking-widest uppercase px-7 py-3
                       disabled:opacity-30 disabled:cursor-not-allowed">
          {{ attempt.currentStage === attempt.totalStages - 1 ? 'Finish â†’' : 'Next Stage â†’' }}
        </button>

      </div>
    </div>

    <!-- â”€â”€ COMPLETED STAGES BELOW (dynamic, not hardcoded) â”€â”€ -->
    @for (ch of attempt.challengeOrder; track ch; let i = $index) {
      @if (i < attempt.currentStage) {
        <div class="w-full max-w-2xl bg-[#0a0a0a] border border-g card-line relative z-10 mt-6 opacity-40 pointer-events-none">
          <div class="flex items-center justify-between px-6 md:px-8 py-5">
            <div>
              <div class="mono text-[#555] text-xs tracking-widest uppercase mb-1">// Challenge 0{{ i + 1 }}</div>
              <div class="font-bold text-lg text-[#555]">{{ challengeTitles[ch] }}</div>
            </div>
            <div class="mono text-[#00ff41] text-xs tracking-widest flex items-center gap-2">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#00ff41" stroke-width="2.5">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
              Passed
            </div>
          </div>
        </div>
      }

      <!-- locked stages below -->
      @if (i > attempt.currentStage) {
        <div class="w-full max-w-2xl bg-[#0a0a0a] border border-g card-line relative z-10 mt-6 opacity-30 pointer-events-none">
          <div class="flex items-center justify-between px-6 md:px-8 py-5">
            <div>
              <div class="mono text-[#333] text-xs tracking-widest uppercase mb-1">// Challenge 0{{ i + 1 }}</div>
              <div class="font-bold text-lg text-[#333]">{{ challengeTitles[ch] }}</div>
            </div>
            <div class="border border-[#1a1a1a] px-3 py-1.5">
              <span class="mono text-[#2a2a2a] text-xs tracking-widest uppercase">ðŸ”’ Locked</span>
            </div>
          </div>
        </div>
      }
    }

    <!-- terminal hint -->
    <div class="mt-8 mono text-[10px] text-[#222] tracking-widest relative z-10 text-center">
      <span class="text-[#00ff41]">$</span> Complete the challenge to proceed
      <span class="blink text-[#00ff41]">_</span>
    </div>

  </main>
  } @else {
  <main class="relative min-h-screen flex flex-col items-center justify-center
               px-4 md:px-8 pt-28 pb-16 overflow-hidden">

    <div class="scan-sweep"></div>

    <div class="w-full max-w-2xl bg-[#0a0a0a] border border-g card-line relative z-10">
      <div class="px-6 md:px-8 py-8">
        <p class="mono text-[#333] text-xs">Loading...</p>
      </div>
    </div>
  </main>
  }

  <app-footer />
</div>
